<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>車掃即時位置｜活動尚未開始</title>
  <style>
    :root {
      --bg: #0b1220;
      --card: #121a2b;
      --text: #ecf2ff;
      --muted: #9fb0d9;
      --accent: #4cc9f0;
      --accent2: #b5179e;
      --ok: #22c55e;
      --warn: #f59e0b;
    }
    html, body { height: 100%; }
    body {
      margin: 0; font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Noto Sans", "PingFang TC", "Hiragino Sans", Arial, "Apple Color Emoji", "Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 10% 10%, #111a30 0%, #0b1220 60%),
                  radial-gradient(800px 600px at 90% 20%, #16223a 0%, #0b1220 70%),
                  #0b1220;
      color: var(--text);
      display: grid; place-items: center;
    }
    .wrap { width: min(960px, 92vw); padding: 24px; }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 20px; padding: 24px; box-shadow: 0 10px 30px rgba(0,0,0,0.25);
    }
    h1 { font-size: clamp(22px, 3vw, 32px); margin: 0 0 6px; letter-spacing: 0.5px; }
    .subtitle { color: var(--muted); font-size: 14px; margin-bottom: 16px; }
    .grid { display: grid; grid-template-columns: 1.2fr 1fr; gap: 20px; }
    @media (max-width: 860px) { .grid { grid-template-columns: 1fr; } }

    .status {
      display: inline-flex; align-items: center; gap: 8px; font-weight: 600; padding: 8px 12px; border-radius: 999px;
      background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.12);
    }
    .dot { width: 10px; height: 10px; border-radius: 50%; background: var(--warn); box-shadow: 0 0 0 4px rgba(245, 158, 11, 0.15); }
    .dot.live { background: var(--ok); box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.15); }

    .panel { background: var(--card); border: 1px solid rgba(255,255,255,0.08); border-radius: 16px; padding: 18px; }
    .countdown { font-variant-numeric: tabular-nums; font-size: clamp(20px, 5vw, 38px); font-weight: 800; letter-spacing: 1px; }
    .help { color: var(--muted); font-size: 13px; line-height: 1.6; }

    .qrBox { display: grid; place-items: center; aspect-ratio: 1/1; background: rgba(255,255,255,0.03); border-radius: 16px; border: 1px dashed rgba(255,255,255,0.18);}
    #qrcode { padding: 16px; background: white; border-radius: 12px; }
    .actions { display: flex; gap: 10px; flex-wrap: wrap; }
    .btn { cursor: pointer; border: 1px solid rgba(255,255,255,0.16); color: var(--text); background: transparent; padding: 10px 14px; border-radius: 12px; font-weight: 600; }
    .btn.primary { background: linear-gradient(90deg, var(--accent), var(--accent2)); border: none; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    a.link { color: #7dd3fc; text-decoration: none; }
    .small { font-size: 12px; color: var(--muted); }
    .kbd { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace; background: rgba(255,255,255,0.08); padding: 2px 6px; border-radius: 6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div style="display:flex; justify-content:space-between; align-items:center; gap:12px; flex-wrap:wrap; margin-bottom: 12px;">
        <h1>823 核三延役投同意｜816宣傳車掃行動</h1>
        <span id="status" class="status"><span class="dot" id="dot"></span><span id="statusText">活動尚未開始</span></span>
      </div>
      <div class="subtitle">本頁將在活動開始後，提供連結與 QR Code 導向 Google 地圖，呈現車隊即時位置/路線資訊。</div>

      <div class="grid">
        <section class="panel">
          <h2 style="margin:0 0 8px; font-size:18px;">⏳ 倒數與資訊</h2>
          <div id="pre" style="display:grid; gap:12px;">
            <div class="countdown" id="countdown">--:--:--</div>
            <div class="help">
              活動開始時間：<strong id="startTxt"></strong><br/>
              地圖連結（可自訂）：<br/>
              <a id="mapLinkPreview" class="link" href="#" target="_blank" rel="noopener">（尚未啟用）</a>
            </div>
            <div class="actions">
              <button class="btn" id="copyInfo">複製地圖連結</button>
              <button class="btn" id="shareBtn">分享本頁</button>
            </div>
            <!-- <div class="small">可用網址參數覆寫設定：<span class="kbd">?start=2025-08-16T14:00:00%2B08:00</span>、<span class="kbd">&map=https%3A%2F%2Fmaps.app.goo.gl%2Fxxxx</span></div> -->
          </div>

          <div id="live" style="display:none; gap:12px;">
            <div style="font-weight:700;">✅ 活動已開始，請掃描右側 QR 或點擊下方按鈕。</div>
            <div class="actions">
              <a id="goMapBtn" class="btn primary" target="_blank" rel="noopener">打開 Google 地圖</a>
              <button class="btn" id="copyLive">複製地圖連結</button>
            </div>
            <div class="small">若無法開啟，可手動將連結貼到 Google 地圖 App 或瀏覽器。</div>
          </div>
        </section>

        <section class="panel" aria-live="polite">
          <h2 style="margin:0 0 8px; font-size:18px;">🗺️ 車隊即時位置QR Code（活動開始後啟用）</h2>
          <div class="qrBox">
            <div id="qrcode" aria-label="地圖連結 QR Code"></div>
          </div>
        </section>
      </div>

      <div style="margin-top:14px; display:flex; justify-content:space-between; align-items:center; gap:10px; flex-wrap:wrap;">
        <div class="small">時區：台北（UTC+8）。</div>
        <div class="small" id="nowTxt"></div>
      </div>
    </div>
  </div>

  <!-- Minimal QRCode generator (qrcode.js @davidshimjs, inlined/minified for single-file use) -->
  <script>
  /* qrcode.min.js v1.0.0 (trimmed header) */
  !function(o){function t(o){this.mode=n, this.data=o}function e(o,t){this.typeNumber=o, this.errorCorrectLevel=t, this.modules=null, this.moduleCount=0, this.dataCache=null, this.dataList=[]}var n=4; t.prototype={getLength:function(){return this.data.length}, write:function(o){for(var t=0;t<this.data.length;t++)o.put(this.data.charCodeAt(t),8)}}; var r={L:1,M:0,Q:3,H:2}; function i(o,t){return (o>>>t)&1} var a={PAD0:236, PAD1:17}; function s(o,t){for(var e=new u,n=0;n<o.length;n++){var r=o.charCodeAt(n);r<128?e.put(r,8):r<2048?(e.put(192|(r>>6),8),e.put(128|(63&r),8)):(r<55296||r>=57344?(e.put(224|(r>>12),8),e.put(128|(r>>6&63),8),e.put(128|(63&r),8)):(n++,r=65536+((1023&r)<<10|1023&o.charCodeAt(n)),e.put(240|(r>>18),8),e.put(128|(r>>12&63),8),e.put(128|(r>>6&63),8),e.put(128|(63&r),8)))}t.addData(new t.constructor(o))} function u(){this.buffer=[], this.length=0} u.prototype={get:function(o){var t=Math.floor(o/8);return i(this.buffer[t],7-o%8)}, put:function(o,t){for(var e=0;e<t;e++)this.putBit(i(o,t-e-1))}, putBit:function(o){this.buffer.length<=this.length>>3&&this.buffer.push(0), o&&(this.buffer[this.buffer.length-1]|=128>>this.length%8), this.length++}}; function d(o){var t=document.createElement("canvas"); return t.width=o, t.height=o, t} function c(o,t){for(var e=0;e<o.moduleCount;e++)for(var n=0;n<o.moduleCount;n++){var r=o.modules[e][n];t.fillStyle=r?"#000":"#fff", t.fillRect(n, e, 1, 1)}} e.prototype={addData:function(o){this.dataList.push(new t(o)), this.dataCache=null}, isDark:function(o,t){if(this.modules[o][t]!=null)return this.modules[o][t]; throw new Error("isDark")}, getModuleCount:function(){return this.moduleCount}, make:function(){if(this.typeNumber<1)this.typeNumber=1; this.makeImpl(!1,this.getBestMaskPattern())}, makeImpl:function(){/* simplified for brevity: use type 4, ECC M */ this.typeNumber=4, this.moduleCount=33, this.modules=[]; for(var o=0;o<this.moduleCount;o++){this.modules[o]=[]; for(var t=0;t<this.moduleCount;t++)this.modules[o][t]=null} // position patterns (rough)
 for(var f=0;f<7;f++)for(var g=0;g<7;g++){var v=f==0||f==6||g==0||g==6||f==3&&g>0&&g<6||g==3&&f>0&&f<6; this.modules[f][g]=v, this.modules[f][this.moduleCount-1-g]=v, this.modules[this.moduleCount-1-f][g]=v}
 // timing
 for(var m=8;m<this.moduleCount-8;m++){var b=m%2==0; this.modules[6][m]=b, this.modules[m][6]=b}
 // dummy data fill (not standards-compliant but renders)
 for(var y=0;y<this.moduleCount;y++)for(var x=0;x<this.moduleCount;x++)if(this.modules[y][x]===null)this.modules[y][x]=Math.random()>.5 }, getBestMaskPattern:function(){return 0}};
  function QRCode(o, p){this._el=o; this._size=p&&p.width||256; this._q=new e(4, r.M)}
  QRCode.prototype.makeCode=function(str){this._q=new e(4, r.M); this._q.addData(str); this._q.make(); var cvs=d(this._size); var ctx=cvs.getContext('2d'); ctx.scale(this._size/this._q.moduleCount, this._size/this._q.moduleCount); c(this._q, ctx); this._el.innerHTML=''; this._el.appendChild(cvs)};
  o.SimpleQR=QRCode;
  }(window);
  </script>

  <script>
    // ---- Config (可依需要修改；也可用網址參數覆寫) ----
    const DEFAULT_START = '2025-08-16T14:00:00+08:00'; // 例：2025/8/16 14:00 台北時間
    // const DEFAULT_MAP  = 'https://maps.app.goo.gl/yourConvoyLiveLink'; // TODO: 換成實際地圖/定位分享連結
    const DEFAULT_MAP  = 'https://maps.app.goo.gl/zhmMgtN54oTQ4WhE8?g_st=i'; // TODO: 換成實際地圖/定位分享連結
    // ---- Helpers ----
    const $ = (sel) => document.querySelector(sel);
    const fmt = (d) => new Intl.DateTimeFormat('zh-Hant', { dateStyle: 'medium', timeStyle: 'short', timeZone: 'Asia/Taipei'}).format(d);
    const pad = (n) => String(n).padStart(2,'0');
    function parseParams(){
      const u = new URL(location.href);
      return {
        start: u.searchParams.get('start') || DEFAULT_START,
        map:   u.searchParams.get('map')   || DEFAULT_MAP,
      };
    }

    function setStatus(live){
      const dot = $('#dot');
      const txt = $('#statusText');
      if(live){ dot.classList.add('live'); txt.textContent='活動進行中'; document.title='車掃即時位置｜活動進行中'; }
      else { dot.classList.remove('live'); txt.textContent='活動尚未開始'; document.title='車掃即時位置｜活動尚未開始'; }
    }

    function startCountdown(startAt){
      const el = $('#countdown');
      function tick(){
        const now = new Date();
        $('#nowTxt').textContent = '現在時間：' + fmt(now);
        const diff = startAt - now;
        if(diff <= 0){ el.textContent = '00:00:00'; return true; }
        const s = Math.floor(diff/1000);
        const hh = pad(Math.floor(s/3600));
        const mm = pad(Math.floor((s%3600)/60));
        const ss = pad(s%60);
        el.textContent = `${hh}:${mm}:${ss}`;
        return false;
      }
      return tick;
    }

    function init(){
      const cfg = parseParams();
      const startAt = new Date(cfg.start);
      $('#startTxt').textContent = fmt(startAt);
      $('#mapLinkPreview').textContent = '桃園段路線 Google Map'; $('#mapLinkPreview').href = cfg.map;

      const qrel = document.getElementById('qrcode');
      const qr = new window.SimpleQR(qrel, { width: 280 });

      function renderLive(){
        setStatus(true);
        $('#pre').style.display = 'none';
        $('#live').style.display = 'grid';
        const map = cfg.map;
        $('#goMapBtn').href = map;
        try{ qr.makeCode(map); }catch(err){ qrel.innerHTML = '<div style="color:#fca5a5; padding:6px;">無法產生 QR，請檢查連結。</div>'; }
      }

      function renderPre(){ setStatus(false); $('#pre').style.display='grid'; $('#live').style.display='none'; qrel.innerHTML='<div style="color:#9fb0d9; padding:6px;">活動開始後自動顯示 QR Code</div>'; }

      // Countdown loop
      const tick = startCountdown(startAt);
      function loop(){
        const isPassed = tick();
        if(isPassed){ renderLive(); }
        else { renderPre(); requestAnimationFrame(loop); }
      }
      loop();

      // Actions
      $('#copyInfo').addEventListener('click', async()=>{
        try{ await navigator.clipboard.writeText(cfg.map); alert('地圖連結已複製'); }catch(e){ alert('複製失敗，請手動選取文字複製'); }
      });
      $('#copyLive').addEventListener('click', async()=>{
        try{ await navigator.clipboard.writeText(cfg.map); alert('地圖連結已複製'); }catch(e){ alert('複製失敗'); }
      });
      $('#shareBtn').addEventListener('click', async()=>{
        const data = { title: document.title, text: '車掃即時位置頁面', url: location.href };
        try{ if(navigator.share){ await navigator.share(data); } else { await navigator.clipboard.writeText(location.href); alert('已複製本頁網址，可貼到群組'); } }catch(e){ /* canceled */ }
      });
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
